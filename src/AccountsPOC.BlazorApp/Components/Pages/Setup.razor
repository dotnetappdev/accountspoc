@page "/setup"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@layout SetupLayout
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Database Setup</PageTitle>

<MudCard Elevation="8" Class="setup-card">
    <MudCardHeader Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <CardHeaderContent>
            <MudText Typo="Typo.h4" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
                Database Setup & Configuration
            </MudText>
            <MudText Typo="Typo.body2">
                Initial Setup: Configure your database connection settings
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>

    @if (currentStep < 3)
    {
        <MudStepper @ref="stepper" Color="Color.Primary" Variant="Variant.Filled" Class="mb-4">
            <MudStep Title="Connection" Icon="@Icons.Material.Filled.Cable" />
            <MudStep Title="Data Options" Icon="@Icons.Material.Filled.Dataset" />
            <MudStep Title="Apply" Icon="@Icons.Material.Filled.Check" />
        </MudStepper>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="() => errorMessage = string.Empty">
            @errorMessage
        </MudAlert>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <MudAlert Severity="Severity.Success" Class="mb-4" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="() => successMessage = string.Empty">
            @successMessage
        </MudAlert>
    }

    <MudCard Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Connection Settings</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <!-- Database Provider -->
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="setupRequest.DatabaseProvider" Label="Database Provider" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("SqlServer")">SQL Server</MudSelectItem>
                        <MudSelectItem Value="@("SQLite")">SQLite</MudSelectItem>
                        <MudSelectItem Value="@("PostgreSQL")">PostgreSQL</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Server/Host -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="setupRequest.Server" 
                                  Label="Server / Host" 
                                  Variant="Variant.Outlined"
                                  Disabled="@(setupRequest.DatabaseProvider == "SQLite")"
                                  HelperText="e.g., localhost, .\SQLEXPRESS, or IP address" />
                </MudItem>

                <!-- Port -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="setupRequest.Port" 
                                  Label="Port (Optional)" 
                                  Variant="Variant.Outlined"
                                  Disabled="@(setupRequest.DatabaseProvider == "SQLite")"
                                  HelperText="SQL Server default: 1433, PostgreSQL: 5432" />
                </MudItem>

                <!-- Database Name -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="setupRequest.Database" 
                                  Label="Database Name" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  HelperText="@(setupRequest.DatabaseProvider == "SQLite" ? "Database file name" : "Database name on server")" />
                </MudItem>

                <!-- Authentication Type Toggle -->
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Authentication</MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSwitch @bind-Value="setupRequest.TrustedConnection" 
                               Label="Windows Authentication / Trusted Connection"
                               Color="Color.Primary"
                               Disabled="@(setupRequest.DatabaseProvider == "SQLite")" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSwitch @bind-Value="setupRequest.IntegratedSecurity" 
                               Label="Integrated Security"
                               Color="Color.Primary"
                               Disabled="@(setupRequest.DatabaseProvider == "SQLite" || setupRequest.TrustedConnection)" />
                </MudItem>

                <!-- Username/Password (shown when not using Windows Auth) -->
                @if (!setupRequest.TrustedConnection && !setupRequest.IntegratedSecurity && setupRequest.DatabaseProvider != "SQLite")
                {
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="setupRequest.Username" 
                                      Label="Username" 
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="setupRequest.Password" 
                                      Label="Password" 
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password" />
                    </MudItem>
                }

                <!-- Security Options -->
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Security Options</MudText>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudSwitch @bind-Value="setupRequest.Encrypt" 
                               Label="Encrypt Connection"
                               Color="Color.Primary"
                               Disabled="@(setupRequest.DatabaseProvider == "SQLite")" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudSwitch @bind-Value="setupRequest.TrustServerCertificate" 
                               Label="Trust Server Certificate"
                               Color="Color.Primary"
                               Disabled="@(setupRequest.DatabaseProvider == "SQLite")" />
                </MudItem>

                <!-- Seed Data Toggles -->
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Data Seeding Options</MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSwitch @bind-Value="setupRequest.SeedBasicData" 
                               Label="Seed Basic Setup Data"
                               Color="Color.Info">
                        <MudText Typo="Typo.body2" Class="ml-2">
                            Include tenants, warehouses, drivers, customers, and basic configuration
                        </MudText>
                    </MudSwitch>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSwitch @bind-Value="setupRequest.SeedUserData" 
                               Label="Seed Sample Users"
                               Color="Color.Success">
                        <MudText Typo="Typo.body2" Class="ml-2">
                            Include 30 pre-configured users with roles and permissions for testing
                        </MudText>
                    </MudSwitch>
                </MudItem>

                <!-- Connection String Preview -->
                <MudItem xs="12">
                    <MudDivider Class="my-4" />
                    <MudTextField @bind-Value="connectionStringPreview" 
                                  Label="Connection String Preview" 
                                  Variant="Variant.Filled"
                                  Lines="3"
                                  ReadOnly="true"
                                  HelperText="This is a preview of the generated connection string" />
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Info" 
                       OnClick="BuildConnectionString"
                       Disabled="isLoading">
                <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-1" />
                Build Connection String
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Warning" 
                       OnClick="TestConnection"
                       Disabled="isLoading || string.IsNullOrEmpty(connectionStringPreview)">
                @if (isTestingConnection)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Testing...</span>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Cable" Class="mr-1" />
                    <span>Test Connection</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       OnClick="ApplyConfiguration"
                       Disabled="isLoading || string.IsNullOrEmpty(connectionStringPreview)">
                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Applying...</span>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Check" Class="mr-1" />
                    <span>Apply Configuration</span>
                }
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (setupComplete && setupResponse != null)
    {
        <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="my-4">
            <MudText Typo="Typo.h5" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Class="mr-2" /> 
                Setup Complete!
            </MudText>
            <MudText Typo="Typo.body1" Class="mb-2">
                @setupResponse.Message
            </MudText>
            
            @if (setupResponse.UsersSeeded.HasValue || setupResponse.RolesSeeded.HasValue)
            {
                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Seeded Data:</strong></MudText>
            }
            
            @if (setupResponse.UsersSeeded.HasValue)
            {
                <MudText Typo="Typo.body2">
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" /> Users Created: <strong>@setupResponse.UsersSeeded</strong>
                </MudText>
            }
            
            @if (setupResponse.RolesSeeded.HasValue)
            {
                <MudText Typo="Typo.body2">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" /> Roles Created: <strong>@setupResponse.RolesSeeded</strong>
                </MudText>
            }

            <MudText Typo="Typo.body2" Class="mt-3">
                Redirecting to tenant setup in <strong>@countdown</strong> seconds...
            </MudText>

            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="NavigateToTenantSetup"
                       Class="mt-3 mr-2"
                       Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-1" />
                Go to Tenant Setup Now
            </MudButton>

            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Primary" 
                       Href="/login"
                       Class="mt-3"
                       Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.Login" Class="mr-1" />
                Skip to Login
            </MudButton>
        </MudAlert>
    }

    </MudCardContent>
</MudCard>

<style>
    .setup-card {
        background: white;
        border-radius: 16px;
    }
</style>

@code {
    private MudStepper? stepper;
    private int currentStep = 0;
    private DatabaseSetupRequest setupRequest = new DatabaseSetupRequest();
    private string connectionStringPreview = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;
    private bool isTestingConnection = false;
    private bool setupComplete = false;
    private DatabaseSetupResponse? setupResponse;
    private int countdown = 5;
    private System.Threading.Timer? countdownTimer;

    protected override void OnInitialized()
    {
        // Set default values
        setupRequest.DatabaseProvider = "SqlServer";
        setupRequest.Server = "localhost";
        setupRequest.Database = "AccountsPOCDb";
        setupRequest.TrustedConnection = true;
        setupRequest.TrustServerCertificate = true;
        setupRequest.SeedBasicData = true;
        setupRequest.SeedUserData = true;
    }

    private async Task BuildConnectionString()
    {
        try
        {
            errorMessage = string.Empty;
            var response = await Http.PostAsJsonAsync("api/setup/build-connection-string", setupRequest);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ConnectionStringResult>();
                if (result != null)
                {
                    connectionStringPreview = result.ConnectionString ?? string.Empty;
                    successMessage = "Connection string generated successfully";
                    currentStep = 1;
                }
            }
            else
            {
                errorMessage = "Failed to build connection string";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task TestConnection()
    {
        try
        {
            isTestingConnection = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            var testRequest = new ConnectionTestRequest
            {
                ConnectionString = connectionStringPreview,
                DatabaseProvider = setupRequest.DatabaseProvider
            };

            var response = await Http.PostAsJsonAsync("api/setup/test-connection", testRequest);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ConnectionTestResponse>();
                if (result != null)
                {
                    if (result.Success)
                    {
                        successMessage = $"Connection successful! Server version: {result.ServerVersion}";
                        currentStep = 2;
                    }
                    else
                    {
                        errorMessage = result.Message;
                    }
                }
            }
            else
            {
                errorMessage = "Failed to test connection";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isTestingConnection = false;
        }
    }

    private async Task ApplyConfiguration()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;
            currentStep = 3;

            var response = await Http.PostAsJsonAsync("api/setup/apply-configuration", setupRequest);
            
            if (response.IsSuccessStatusCode)
            {
                setupResponse = await response.Content.ReadFromJsonAsync<DatabaseSetupResponse>();
                if (setupResponse != null && setupResponse.Success)
                {
                    setupComplete = true;
                    successMessage = "Database setup completed successfully!";
                    StartCountdown();
                }
                else
                {
                    errorMessage = setupResponse?.Message ?? "Setup failed";
                    currentStep = 2;
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Failed to apply configuration: {error}";
                currentStep = 2;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            currentStep = 2;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartCountdown()
    {
        countdownTimer = new System.Threading.Timer(async _ =>
        {
            countdown--;
            if (countdown <= 0)
            {
                countdownTimer?.Dispose();
                await InvokeAsync(() =>
                {
                    NavigateToTenantSetup();
                });
            }
            else
            {
                await InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void NavigateToTenantSetup()
    {
        countdownTimer?.Dispose();
        // Navigate to tenant setup page - adjust the route as needed
        Navigation.NavigateTo("/tenants", forceLoad: true);
    }

    public void Dispose()
    {
        countdownTimer?.Dispose();
    }

    public class DatabaseSetupRequest
    {
        public string Server { get; set; } = "localhost";
        public string? Port { get; set; }
        public string Database { get; set; } = "AccountsPOCDb";
        public string? Username { get; set; }
        public string? Password { get; set; }
        public bool TrustedConnection { get; set; } = true;
        public bool TrustServerCertificate { get; set; } = true;
        public bool Encrypt { get; set; } = false;
        public bool IntegratedSecurity { get; set; } = true;
        public string DatabaseProvider { get; set; } = "SqlServer";
        public bool SeedBasicData { get; set; } = false;
        public bool SeedUserData { get; set; } = false;
    }

    public class ConnectionStringResult
    {
        public string? ConnectionString { get; set; }
    }

    public class ConnectionTestRequest
    {
        public required string ConnectionString { get; set; }
        public string DatabaseProvider { get; set; } = "SqlServer";
    }

    public class ConnectionTestResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public string? ServerVersion { get; set; }
    }

    public class DatabaseSetupResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public string? ConnectionString { get; set; }
        public int? UsersSeeded { get; set; }
        public int? RolesSeeded { get; set; }
    }
}
