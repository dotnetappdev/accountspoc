@page "/sales-orders"
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@using Microsoft.JSInterop
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Sales Orders</PageTitle>

<div class="container-fluid">
    <h1 class="mb-4">Sales Orders</h1>

    <div class="row mb-3">
        <div class="col">
            <button class="btn btn-primary" @onclick="ShowAddForm">
                <i class="bi bi-plus-circle"></i> Create New Sales Order
            </button>
        </div>
    </div>

    @if (showForm)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>@(editingOrder != null ? "Edit" : "Create") Sales Order</h5>
            </div>
            <div class="card-body">
                <EditForm Model="currentOrder" OnValidSubmit="SaveSalesOrder">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Number</label>
                            <InputText class="form-control" @bind-Value="currentOrder.OrderNumber" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Name</label>
                            <InputText class="form-control" @bind-Value="currentOrder.CustomerName" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Email</label>
                            <InputText class="form-control" type="email" @bind-Value="currentOrder.CustomerEmail" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Phone</label>
                            <InputText class="form-control" @bind-Value="currentOrder.CustomerPhone" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <InputSelect class="form-select" @bind-Value="currentOrder.Status">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <h6>Order Items</h6>
                        <div class="card">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-5">
                                        <label class="form-label">Product</label>
                                        <select class="form-select" @bind="SelectedProductId">
                                            <option value="0">-- Select Product --</option>
                                            @if (products != null)
                                            {
                                                @foreach (var product in products)
                                                {
                                                    <option value="@product.Id">@product.ProductName - @product.ProductCode (@product.UnitPrice.ToString("C"))</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control" @bind="newItemQuantity" min="1" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Unit Price</label>
                                        <input type="number" class="form-control" @bind="newItemUnitPrice" step="0.01" min="0" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-primary w-100" @onclick="AddLineItem">
                                            <i class="bi bi-plus-circle"></i> Add Item
                                        </button>
                                    </div>
                                </div>

                                @if (currentOrder.SalesOrderItems.Any())
                                {
                                    <MudDataGrid T="SalesOrderItem" Items="@currentOrder.SalesOrderItems" 
                                                 Dense="true"
                                                 Hover="true"
                                                 Striped="true"
                                                 Bordered="true">
                                        <Columns>
                                            <TemplateColumn Title="Product">
                                                <CellTemplate Context="itemContext">
                                                    @(itemContext.Item.Product?.ProductName ?? "Unknown")
                                                </CellTemplate>
                                            </TemplateColumn>
                                            <TemplateColumn Title="Code">
                                                <CellTemplate Context="itemContext">
                                                    @(itemContext.Item.Product?.ProductCode ?? "N/A")
                                                </CellTemplate>
                                            </TemplateColumn>
                                            <PropertyColumn Property="x => x.Quantity" Title="Quantity" />
                                            <PropertyColumn Property="x => x.UnitPrice" Title="Unit Price" Format="C" />
                                            <PropertyColumn Property="x => x.TotalPrice" Title="Total" Format="C" />
                                            <TemplateColumn Title="Actions" Filterable="false" Sortable="false">
                                                <CellTemplate Context="itemContext">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                                 Color="Color.Error" 
                                                                 Size="Size.Small" 
                                                                 OnClick="@(() => RemoveLineItem(itemContext.Item))" />
                                                </CellTemplate>
                                            </TemplateColumn>
                                        </Columns>
                                    </MudDataGrid>

                                    <div class="mt-3 text-end">
                                        <h5>
                                            <strong>Total: @CalculateOrderTotal().ToString("C")</strong>
                                        </h5>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info">No items added yet.</div>
                                }
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </EditForm>
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="d-flex justify-content-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (salesOrders == null || !salesOrders.Any())
    {
        <div class="alert alert-info">No sales orders found.</div>
    }
    else
    {
        <MudDataGrid T="SalesOrder" Items="@salesOrders" 
                     Filterable="true" 
                     FilterMode="DataGridFilterMode.ColumnFilterMenu"
                     SortMode="SortMode.Multiple"
                     QuickFilter="@_quickFilter"
                     Hideable="true"
                     ColumnResizeMode="ResizeMode.Column"
                     Dense="true"
                     Hover="true"
                     Striped="true"
                     Bordered="true"
                     FixedHeader="true"
                     Height="600px">
            <ToolBarContent>
                <MudSpacer />
                <MudTextField @bind-Value="_searchString" 
                             Placeholder="Search" 
                             Adornment="Adornment.Start" 
                             AdornmentIcon="@Icons.Material.Filled.Search" 
                             IconSize="Size.Medium" 
                             Class="mt-0"
                             Immediate="true"></MudTextField>
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.OrderNumber" Title="Order Number" Filterable="true" Sortable="true">
                    <CellTemplate>
                        <MudText Typo="Typo.body2"><strong>@context.Item.OrderNumber</strong></MudText>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.OrderDate" Title="Order Date" Filterable="true" Sortable="true" Format="d" />
                <PropertyColumn Property="x => x.CustomerName" Title="Customer Name" Filterable="true" Sortable="true" />
                <PropertyColumn Property="x => x.TotalAmount" Title="Total Amount" Filterable="true" Sortable="true" Format="C" />
                <PropertyColumn Property="x => x.Status" Title="Status" Filterable="true" Sortable="true">
                    <CellTemplate>
                        @{
                            var statusColor = context.Item.Status switch
                            {
                                "Completed" => Color.Success,
                                "Pending" => Color.Warning,
                                "Cancelled" => Color.Error,
                                "Processing" => Color.Info,
                                _ => Color.Default
                            };
                        }
                        <MudChip Size="Size.Small" Color="@statusColor">@context.Item.Status</MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.SalesOrderItems.Count" Title="Items" Filterable="false" Sortable="true">
                    <CellTemplate>
                        @(context.Item.SalesOrderItems?.Count ?? 0) items
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Actions" Filterable="false" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                         Color="Color.Info" 
                                         Size="Size.Small" 
                                         OnClick="@(() => ViewOrderDetails(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                         Color="Color.Warning" 
                                         Size="Size.Small" 
                                         OnClick="@(() => EditSalesOrder(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.PictureAsPdf" 
                                         Color="Color.Secondary" 
                                         Size="Size.Small" 
                                         Title="Download PDF"
                                         OnClick="@(() => DownloadPdf(context.Item.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                         Color="Color.Error" 
                                         Size="Size.Small" 
                                         OnClick="@(() => DeleteSalesOrder(context.Item.Id))" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="SalesOrder" PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudDataGrid>
    }
</div>

@code {
    private List<SalesOrder>? salesOrders;
    private List<Product>? products;
    private SalesOrder currentOrder = new() 
    { 
        OrderNumber = "", 
        CustomerName = "", 
        Status = "Pending",
        SalesOrderItems = new List<SalesOrderItem>()
    };
    private SalesOrder? editingOrder;
    private bool showForm = false;
    private bool loading = true;
    private string _searchString = "";
    
    // Line item fields
    private int selectedProductId = 0;
    private int newItemQuantity = 1;
    private decimal newItemUnitPrice = 0;

    private int SelectedProductId
    {
        get => selectedProductId;
        set
        {
            selectedProductId = value;
            if (value > 0)
            {
                var product = products?.FirstOrDefault(p => p.Id == value);
                if (product != null)
                {
                    newItemUnitPrice = product.UnitPrice;
                }
            }
            else
            {
                newItemUnitPrice = 0;
            }
        }
    }

    private Func<SalesOrder, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.OrderNumber?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.CustomerName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.Status?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadSalesOrders();
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            products = await Http.GetFromJsonAsync<List<Product>>("api/Products");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading products: {ex.Message}");
            products = new List<Product>();
        }
    }

    private async Task LoadSalesOrders()
    {
        loading = true;
        try
        {
            salesOrders = await Http.GetFromJsonAsync<List<SalesOrder>>("api/SalesOrders");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sales orders: {ex.Message}");
            salesOrders = new List<SalesOrder>();
        }
        loading = false;
    }

    private void ShowAddForm()
    {
        currentOrder = new() 
        { 
            OrderNumber = $"SO-{DateTime.Now:yyyyMMddHHmmss}", 
            CustomerName = "", 
            Status = "Pending",
            SalesOrderItems = new List<SalesOrderItem>()
        };
        editingOrder = null;
        showForm = true;
        ResetLineItemFields();
    }

    private async Task EditSalesOrder(SalesOrder order)
    {
        editingOrder = order;
        
        try
        {
            // Fetch the full order with items
            var fullOrder = await Http.GetFromJsonAsync<SalesOrder>($"api/SalesOrders/{order.Id}");
            
            if (fullOrder != null)
            {
                currentOrder = new SalesOrder
                {
                    Id = fullOrder.Id,
                    OrderNumber = fullOrder.OrderNumber,
                    OrderDate = fullOrder.OrderDate,
                    CustomerName = fullOrder.CustomerName,
                    CustomerEmail = fullOrder.CustomerEmail,
                    CustomerPhone = fullOrder.CustomerPhone,
                    TotalAmount = fullOrder.TotalAmount,
                    Status = fullOrder.Status,
                    CreatedDate = fullOrder.CreatedDate,
                    LastModifiedDate = fullOrder.LastModifiedDate,
                    SalesOrderItems = fullOrder.SalesOrderItems?.ToList() ?? new List<SalesOrderItem>()
                };
            }
            
            showForm = true;
            ResetLineItemFields();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading order details: {ex.Message}");
        }
        
        StateHasChanged();
    }

    private async Task SaveSalesOrder()
    {
        try
        {
            // Calculate total amount before saving
            currentOrder.TotalAmount = CalculateOrderTotal();
            
            if (editingOrder != null)
            {
                await Http.PutAsJsonAsync($"api/SalesOrders/{currentOrder.Id}", currentOrder);
            }
            else
            {
                await Http.PostAsJsonAsync("api/SalesOrders", currentOrder);
            }
            
            showForm = false;
            await LoadSalesOrders();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving sales order: {ex.Message}");
        }
    }

    private void AddLineItem()
    {
        if (selectedProductId == 0 || newItemQuantity <= 0 || newItemUnitPrice < 0)
        {
            return;
        }

        var selectedProduct = products?.FirstOrDefault(p => p.Id == selectedProductId);
        if (selectedProduct == null)
        {
            return;
        }

        var newItem = new SalesOrderItem
        {
            ProductId = selectedProductId,
            Product = selectedProduct,
            Quantity = newItemQuantity,
            UnitPrice = newItemUnitPrice,
            TotalPrice = newItemQuantity * newItemUnitPrice
        };

        currentOrder.SalesOrderItems.Add(newItem);
        ResetLineItemFields();
    }

    private void RemoveLineItem(SalesOrderItem item)
    {
        currentOrder.SalesOrderItems.Remove(item);
    }

    private void ResetLineItemFields()
    {
        selectedProductId = 0;
        newItemQuantity = 1;
        newItemUnitPrice = 0;
    }

    private decimal CalculateOrderTotal()
    {
        return currentOrder.SalesOrderItems.Sum(i => i.TotalPrice);
    }

    private async Task DeleteSalesOrder(int id)
    {
        try
        {
            await Http.DeleteAsync($"api/SalesOrders/{id}");
            await LoadSalesOrders();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting sales order: {ex.Message}");
        }
    }

    private void ViewOrderDetails(SalesOrder order)
    {
        // In a real app, navigate to a details page
    }

    private void CancelForm()
    {
        showForm = false;
        editingOrder = null;
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning",
            "Processing" => "bg-info",
            "Completed" => "bg-success",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task DownloadPdf(int orderId)
    {
        try
        {
            var response = await Http.GetAsync($"api/SalesOrders/{orderId}/pdf");
            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"SalesOrder_{orderId}_{DateTime.Now:yyyyMMddHHmmss}.pdf";
                
                // Download file using JavaScript interop
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", fileBytes);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading PDF: {ex.Message}");
        }
    }
}
