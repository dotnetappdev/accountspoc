@page "/sales-orders"
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Sales Orders</PageTitle>

<div class="container-fluid">
    <h1 class="mb-4">Sales Orders</h1>

    <div class="row mb-3">
        <div class="col">
            <button class="btn btn-primary" @onclick="ShowAddForm">
                <i class="bi bi-plus-circle"></i> Create New Sales Order
            </button>
        </div>
    </div>

    @if (showForm)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>@(editingOrder != null ? "Edit" : "Create") Sales Order</h5>
            </div>
            <div class="card-body">
                <EditForm Model="currentOrder" OnValidSubmit="SaveSalesOrder">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Number</label>
                            <InputText class="form-control" @bind-Value="currentOrder.OrderNumber" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Name</label>
                            <InputText class="form-control" @bind-Value="currentOrder.CustomerName" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Email</label>
                            <InputText class="form-control" type="email" @bind-Value="currentOrder.CustomerEmail" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Phone</label>
                            <InputText class="form-control" @bind-Value="currentOrder.CustomerPhone" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <InputSelect class="form-select" @bind-Value="currentOrder.Status">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </InputSelect>
                    </div>
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </EditForm>
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="d-flex justify-content-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (salesOrders == null || !salesOrders.Any())
    {
        <div class="alert alert-info">No sales orders found.</div>
    }
    else
    {
        <MudDataGrid T="SalesOrder" Items="@salesOrders" 
                     Filterable="true" 
                     FilterMode="DataGridFilterMode.ColumnFilterMenu"
                     SortMode="SortMode.Multiple"
                     QuickFilter="@_quickFilter"
                     Hideable="true"
                     ColumnResizeMode="ResizeMode.Column"
                     Dense="true"
                     Hover="true"
                     Striped="true"
                     Bordered="true"
                     FixedHeader="true"
                     Height="600px">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Sales Orders</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="_searchString" 
                             Placeholder="Search" 
                             Adornment="Adornment.Start" 
                             AdornmentIcon="@Icons.Material.Filled.Search" 
                             IconSize="Size.Medium" 
                             Class="mt-0"
                             Immediate="true"></MudTextField>
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.OrderNumber" Title="Order Number" Filterable="true" Sortable="true">
                    <CellTemplate>
                        <MudText Typo="Typo.body2"><strong>@context.Item.OrderNumber</strong></MudText>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.OrderDate" Title="Order Date" Filterable="true" Sortable="true" Format="d" />
                <PropertyColumn Property="x => x.CustomerName" Title="Customer Name" Filterable="true" Sortable="true" />
                <PropertyColumn Property="x => x.TotalAmount" Title="Total Amount" Filterable="true" Sortable="true" Format="C" />
                <PropertyColumn Property="x => x.Status" Title="Status" Filterable="true" Sortable="true">
                    <CellTemplate>
                        @{
                            var statusColor = context.Item.Status switch
                            {
                                "Completed" => Color.Success,
                                "Pending" => Color.Warning,
                                "Cancelled" => Color.Error,
                                "Processing" => Color.Info,
                                _ => Color.Default
                            };
                        }
                        <MudChip Size="Size.Small" Color="@statusColor">@context.Item.Status</MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.SalesOrderItems.Count" Title="Items" Filterable="false" Sortable="true">
                    <CellTemplate>
                        @context.Item.SalesOrderItems.Count items
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Actions" Filterable="false" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                         Color="Color.Info" 
                                         Size="Size.Small" 
                                         OnClick="@(() => ViewOrderDetails(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                         Color="Color.Warning" 
                                         Size="Size.Small" 
                                         OnClick="@(() => EditSalesOrder(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                         Color="Color.Error" 
                                         Size="Size.Small" 
                                         OnClick="@(() => DeleteSalesOrder(context.Item.Id))" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="SalesOrder" PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudDataGrid>
    }
</div>

@code {
    private List<SalesOrder>? salesOrders;
    private SalesOrder currentOrder = new() { OrderNumber = "", CustomerName = "", Status = "Pending" };
    private SalesOrder? editingOrder;
    private bool showForm = false;
    private bool loading = true;
    private string _searchString = "";

    private Func<SalesOrder, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.OrderNumber?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.CustomerName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.Status?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadSalesOrders();
    }

    private async Task LoadSalesOrders()
    {
        loading = true;
        try
        {
            salesOrders = await Http.GetFromJsonAsync<List<SalesOrder>>("api/SalesOrders");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sales orders: {ex.Message}");
            salesOrders = new List<SalesOrder>();
        }
        loading = false;
    }

    private void ShowAddForm()
    {
        currentOrder = new() { OrderNumber = $"SO-{DateTime.Now:yyyyMMddHHmmss}", CustomerName = "", Status = "Pending" };
        editingOrder = null;
        showForm = true;
    }

    private void EditSalesOrder(SalesOrder order)
    {
        editingOrder = order;
        currentOrder = new SalesOrder
        {
            Id = order.Id,
            OrderNumber = order.OrderNumber,
            OrderDate = order.OrderDate,
            CustomerName = order.CustomerName,
            CustomerEmail = order.CustomerEmail,
            CustomerPhone = order.CustomerPhone,
            TotalAmount = order.TotalAmount,
            Status = order.Status,
            CreatedDate = order.CreatedDate,
            LastModifiedDate = order.LastModifiedDate
        };
        showForm = true;
    }

    private async Task SaveSalesOrder()
    {
        try
        {
            if (editingOrder != null)
            {
                await Http.PutAsJsonAsync($"api/SalesOrders/{currentOrder.Id}", currentOrder);
            }
            else
            {
                await Http.PostAsJsonAsync("api/SalesOrders", currentOrder);
            }
            
            showForm = false;
            await LoadSalesOrders();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving sales order: {ex.Message}");
        }
    }

    private async Task DeleteSalesOrder(int id)
    {
        try
        {
            await Http.DeleteAsync($"api/SalesOrders/{id}");
            await LoadSalesOrders();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting sales order: {ex.Message}");
        }
    }

    private void ViewOrderDetails(SalesOrder order)
    {
        // In a real app, navigate to a details page
    }

    private void CancelForm()
    {
        showForm = false;
        editingOrder = null;
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning",
            "Processing" => "bg-info",
            "Completed" => "bg-success",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
