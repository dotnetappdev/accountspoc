@page "/paymentproviderconfigs"
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Payment Provider Configuration</PageTitle>

<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-credit-card-2-back-fill"></i> Payment Provider Configuration
        </h1>
        <p class="text-muted">Configure and manage payment provider integrations</p>
    </div>

    <div class="row mb-4">
        <div class="col">
            <button class="btn btn-primary gradient-btn" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle"></i> Add Payment Provider
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (providers == null || !providers.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="bi bi-credit-card"></i>
            </div>
            <h3>No Payment Providers Configured</h3>
            <p>Add your first payment provider to start accepting payments</p>
            <button class="btn btn-primary gradient-btn" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle"></i> Add Payment Provider
            </button>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var provider in providers)
            {
                <div class="col-lg-6 col-xl-4">
                    <div class="provider-card">
                        <div class="provider-header">
                            <div class="provider-icon">
                                <i class="bi @GetProviderIcon(provider.ProviderCode)"></i>
                            </div>
                            <div class="provider-info">
                                <h3 class="provider-name">@provider.ProviderName</h3>
                                <span class="provider-code">@provider.ProviderCode</span>
                            </div>
                        </div>

                        <div class="provider-badges">
                            @if (provider.IsEnabled)
                            {
                                <span class="badge badge-success"><i class="bi bi-check-circle"></i> Enabled</span>
                            }
                            else
                            {
                                <span class="badge badge-secondary"><i class="bi bi-x-circle"></i> Disabled</span>
                            }
                            
                            @if (provider.IsDefault)
                            {
                                <span class="badge badge-primary"><i class="bi bi-star-fill"></i> Default</span>
                            }

                            @if (provider.Environment == "Test")
                            {
                                <span class="badge badge-warning"><i class="bi bi-flask"></i> Test</span>
                            }
                            else
                            {
                                <span class="badge badge-production"><i class="bi bi-shield-check"></i> Production</span>
                            }
                        </div>

                        <div class="provider-details">
                            @if (!string.IsNullOrEmpty(provider.PublishableKey))
                            {
                                <div class="detail-row">
                                    <label>Publishable Key</label>
                                    <span class="masked-key">@MaskKey(provider.PublishableKey)</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(provider.MerchantId))
                            {
                                <div class="detail-row">
                                    <label>Merchant ID</label>
                                    <span class="masked-key">@MaskKey(provider.MerchantId)</span>
                                </div>
                            }
                        </div>

                        <div class="provider-actions">
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => TestConnection(provider)">
                                <i class="bi bi-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowEditModal(provider)">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProvider(provider.Id)">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showModal)
{
    <ModalDialog Title="@(editingProvider != null ? "Edit Payment Provider" : "Add Payment Provider")" 
                 IsVisible="@showModal" 
                 OnClose="CloseModal"
                 Size="xl">
        <Body>
            <EditForm Model="currentProvider" OnValidSubmit="SaveProvider">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(activeTab == "basic" ? "active" : "")" 
                                type="button" 
                                @onclick="@(() => SetActiveTab("basic"))">
                            <i class="bi bi-info-circle"></i> Basic Info
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(activeTab == "credentials" ? "active" : "")" 
                                type="button" 
                                @onclick="@(() => SetActiveTab("credentials"))">
                            <i class="bi bi-key"></i> Credentials
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(activeTab == "settings" ? "active" : "")" 
                                type="button" 
                                @onclick="@(() => SetActiveTab("settings"))">
                            <i class="bi bi-gear"></i> Settings
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    @if (activeTab == "basic")
                    {
                        <div class="tab-pane-content">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Provider Name <span class="text-danger">*</span></label>
                                    <InputText class="form-control" @bind-Value="currentProvider.ProviderName" placeholder="Stripe" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Provider Code <span class="text-danger">*</span></label>
                                    <InputSelect class="form-select" @bind-Value="currentProvider.ProviderCode">
                                        <option value="">Select Provider</option>
                                        <option value="STRIPE">Stripe</option>
                                        <option value="APPLEPAY">Apple Pay</option>
                                        <option value="GOOGLEPAY">Google Pay</option>
                                        <option value="PAYPAL">PayPal</option>
                                        <option value="SQUARE">Square</option>
                                        <option value="BRAINTREE">Braintree</option>
                                        <option value="AUTHORIZE_NET">Authorize.Net</option>
                                    </InputSelect>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Environment <span class="text-danger">*</span></label>
                                    <InputSelect class="form-select" @bind-Value="currentProvider.Environment">
                                        <option value="Test">Test</option>
                                        <option value="Production">Production</option>
                                    </InputSelect>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Status</label>
                                    <div class="mt-2">
                                        <div class="form-check form-switch mb-2">
                                            <InputCheckbox class="form-check-input" @bind-Value="currentProvider.IsEnabled" id="isEnabled" />
                                            <label class="form-check-label" for="isEnabled">Enabled</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <InputCheckbox class="form-check-input" @bind-Value="currentProvider.IsDefault" id="isDefault" />
                                            <label class="form-check-label" for="isDefault">Set as Default Provider</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (activeTab == "credentials")
                    {
                        <div class="tab-pane-content">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Publishable Key</label>
                                    <InputText class="form-control" @bind-Value="currentProvider.PublishableKey" placeholder="pk_test_..." />
                                    <small class="form-text text-muted">Public API key</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Secret Key</label>
                                    <InputText class="form-control" type="password" @bind-Value="currentProvider.SecretKey" placeholder="sk_test_..." />
                                    <small class="form-text text-muted">Secret API key (keep secure)</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">API Key</label>
                                    <InputText class="form-control" type="password" @bind-Value="currentProvider.ApiKey" placeholder="API Key" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Merchant ID</label>
                                    <InputText class="form-control" @bind-Value="currentProvider.MerchantId" placeholder="Merchant ID" />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Webhook Secret</label>
                                <InputText class="form-control" type="password" @bind-Value="currentProvider.WebhookSecret" placeholder="whsec_..." />
                                <small class="form-text text-muted">Webhook signing secret for event verification</small>
                            </div>
                        </div>
                    }
                    else if (activeTab == "settings")
                    {
                        <div class="tab-pane-content">
                            <div class="mb-3">
                                <label class="form-label">Additional Configuration (JSON)</label>
                                <InputTextArea class="form-control font-monospace" @bind-Value="currentProvider.AdditionalConfig" rows="8" 
                                              placeholder='{"key": "value"}' />
                                <small class="form-text text-muted">Additional provider-specific settings in JSON format</small>
                            </div>
                        </div>
                    }
                </div>

                <div class="mt-4 d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="submit" class="btn btn-success gradient-btn">
                        <i class="bi bi-check-circle"></i> Save Provider
                    </button>
                </div>
            </EditForm>
        </Body>
    </ModalDialog>
}

@if (showTestModal)
{
    <ModalDialog Title="Test Connection Result" 
                 IsVisible="@showTestModal" 
                 OnClose="CloseTestModal"
                 Size="md">
        <Body>
            <div class="test-result @(testSuccess ? "test-success" : "test-error")">
                <div class="test-icon">
                    <i class="bi @(testSuccess ? "bi-check-circle-fill" : "bi-x-circle-fill")"></i>
                </div>
                <h4>@(testSuccess ? "Connection Successful" : "Connection Failed")</h4>
                <p>@testMessage</p>
            </div>
            <div class="mt-3 d-flex justify-content-end">
                <button type="button" class="btn btn-primary" @onclick="CloseTestModal">Close</button>
            </div>
        </Body>
    </ModalDialog>
}

<style>
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .gradient-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .gradient-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .empty-icon {
        width: 100px;
        height: 100px;
        margin: 0 auto 2rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: white;
    }

    .empty-state h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #6c757d;
        margin-bottom: 2rem;
    }

    .provider-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .provider-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .provider-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .provider-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .provider-info {
        flex: 1;
    }

    .provider-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .provider-code {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
    }

    .provider-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .badge-success {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-secondary {
        background-color: #e9ecef;
        color: #6c757d;
    }

    .badge-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-production {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .provider-details {
        flex: 1;
        margin-bottom: 1rem;
    }

    .detail-row {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-row label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
        margin: 0;
    }

    .masked-key {
        font-family: monospace;
        font-size: 0.875rem;
        color: #2c3e50;
        font-weight: 500;
    }

    .provider-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .provider-actions .btn-sm {
        flex: 1;
        min-width: max-content;
    }

    .test-result {
        text-align: center;
        padding: 2rem;
        border-radius: 12px;
    }

    .test-success {
        background-color: #d4edda;
        color: #155724;
    }

    .test-error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .test-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .test-result h4 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .font-monospace {
        font-family: 'Courier New', Courier, monospace;
    }

    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        transition: all 0.2s ease;
    }

    .nav-tabs .nav-link:hover {
        color: #667eea;
        border-bottom: 2px solid #667eea;
    }

    .nav-tabs .nav-link.active {
        color: #667eea;
        border-bottom: 2px solid #667eea;
        background: transparent;
    }

    .tab-pane-content {
        padding: 1.5rem 0;
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

@code {
    private List<PaymentProviderConfig>? providers;
    private PaymentProviderConfig currentProvider = new();
    private PaymentProviderConfig? editingProvider;
    private bool loading = true;
    private bool showModal = false;
    private bool showTestModal = false;
    private bool testSuccess = false;
    private string testMessage = "";
    private string activeTab = "basic";

    protected override async Task OnInitializedAsync()
    {
        await LoadProviders();
    }

    private async Task LoadProviders()
    {
        try
        {
            loading = true;
            providers = await Http.GetFromJsonAsync<List<PaymentProviderConfig>>("api/paymentproviderconfigs");
            if (providers == null)
            {
                providers = new List<PaymentProviderConfig>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading payment providers: {ex.Message}");
            providers = new List<PaymentProviderConfig>();
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowAddModal()
    {
        editingProvider = null;
        activeTab = "basic";
        currentProvider = new PaymentProviderConfig
        {
            TenantId = 1,
            Environment = "Test",
            IsEnabled = true,
            IsDefault = false,
            CreatedDate = DateTime.UtcNow
        };
        showModal = true;
    }

    private void ShowEditModal(PaymentProviderConfig provider)
    {
        editingProvider = provider;
        activeTab = "basic";
        currentProvider = new PaymentProviderConfig
        {
            Id = provider.Id,
            TenantId = provider.TenantId,
            ProviderName = provider.ProviderName,
            ProviderCode = provider.ProviderCode,
            PublishableKey = provider.PublishableKey,
            SecretKey = provider.SecretKey,
            ApiKey = provider.ApiKey,
            MerchantId = provider.MerchantId,
            WebhookSecret = provider.WebhookSecret,
            Environment = provider.Environment,
            IsEnabled = provider.IsEnabled,
            IsDefault = provider.IsDefault,
            AdditionalConfig = provider.AdditionalConfig,
            CreatedDate = provider.CreatedDate
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editingProvider = null;
        activeTab = "basic";
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void CloseTestModal()
    {
        showTestModal = false;
    }

    private async Task SaveProvider()
    {
        try
        {
            currentProvider.LastModifiedDate = DateTime.UtcNow;

            if (editingProvider != null)
            {
                var response = await Http.PutAsJsonAsync($"api/paymentproviderconfigs/{currentProvider.Id}", currentProvider);
                if (response.IsSuccessStatusCode)
                {
                    await LoadProviders();
                }
            }
            else
            {
                var response = await Http.PostAsJsonAsync("api/paymentproviderconfigs", currentProvider);
                if (response.IsSuccessStatusCode)
                {
                    await LoadProviders();
                }
            }

            CloseModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving payment provider: {ex.Message}");
        }
    }

    private async Task DeleteProvider(int id)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this payment provider?"))
            return;

        try
        {
            var response = await Http.DeleteAsync($"api/paymentproviderconfigs/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadProviders();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting payment provider: {ex.Message}");
        }
    }

    private async Task TestConnection(PaymentProviderConfig provider)
    {
        try
        {
            // Simulate API call to test connection
            await Task.Delay(1000); // Simulate network delay
            
            // In a real implementation, you would call an API endpoint to test the connection
            // var response = await Http.PostAsJsonAsync($"api/paymentproviderconfigs/{provider.Id}/test", provider);
            
            testSuccess = true;
            testMessage = $"Successfully connected to {provider.ProviderName} ({provider.Environment} environment)";
        }
        catch (Exception ex)
        {
            testSuccess = false;
            testMessage = $"Connection failed: {ex.Message}";
        }
        finally
        {
            showTestModal = true;
        }
    }

    private string MaskKey(string? key)
    {
        if (string.IsNullOrEmpty(key) || key.Length <= 8)
            return "••••••••";

        var first4 = key.Substring(0, 4);
        var last4 = key.Substring(key.Length - 4);
        return $"{first4}••••{last4}";
    }

    private string GetProviderIcon(string? code)
    {
        return code?.ToUpper() switch
        {
            "STRIPE" => "bi-stripe",
            "APPLEPAY" => "bi-apple",
            "GOOGLEPAY" => "bi-google",
            "PAYPAL" => "bi-paypal",
            "SQUARE" => "bi-square-fill",
            "BRAINTREE" => "bi-wallet2",
            "AUTHORIZE_NET" => "bi-shield-check",
            _ => "bi-credit-card-2-front"
        };
    }

    public class PaymentProviderConfig
    {
        public int Id { get; set; }
        public int TenantId { get; set; }
        public string ProviderName { get; set; } = string.Empty;
        public string ProviderCode { get; set; } = string.Empty;
        public string? PublishableKey { get; set; }
        public string? SecretKey { get; set; }
        public string? ApiKey { get; set; }
        public string? MerchantId { get; set; }
        public string? WebhookSecret { get; set; }
        public string Environment { get; set; } = "Test";
        public bool IsEnabled { get; set; }
        public bool IsDefault { get; set; }
        public string? AdditionalConfig { get; set; }
        public DateTime CreatedDate { get; set; }
        public DateTime? LastModifiedDate { get; set; }
    }
}
