@page "/invoice-payment/{InvoiceId:int}"
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Pay Invoice</PageTitle>

<div class="container" style="max-width: 600px; margin-top: 50px;">
    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading invoice details...</p>
        </div>
    }
    else if (invoice == null)
    {
        <div class="alert alert-danger">
            <h4 class="alert-heading">Invoice Not Found</h4>
            <p>The invoice you're trying to pay could not be found.</p>
        </div>
    }
    else
    {
        <div class="card shadow-lg">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3 class="mb-0">Pay Invoice #@invoice.InvoiceNumber</h3>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-6">
                        <p class="text-muted mb-1">Invoice Date:</p>
                        <p class="fw-bold">@invoice.InvoiceDate.ToShortDateString()</p>
                    </div>
                    <div class="col-6 text-end">
                        <p class="text-muted mb-1">Due Date:</p>
                        <p class="fw-bold">@invoice.DueDate?.ToShortDateString()</p>
                    </div>
                </div>

                <hr />

                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Sub Total:</span>
                        <span class="fs-5">@invoice.SubTotal.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Tax:</span>
                        <span class="fs-5">@invoice.TaxAmount.ToString("C")</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-4">Total Amount:</span>
                        <span class="fw-bold fs-3" style="color: #667eea;">@invoice.TotalAmount.ToString("C")</span>
                    </div>
                </div>

                @if (invoice.Status == "Paid")
                {
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> This invoice has already been paid.
                    </div>
                }
                else if (paymentSuccess)
                {
                    <div class="alert alert-success">
                        <h5 class="alert-heading"><i class="bi bi-check-circle"></i> Payment Successful!</h5>
                        <p>Your payment has been processed successfully.</p>
                        <p class="mb-0">Transaction ID: <strong>@transactionId</strong></p>
                    </div>
                }
                else if (paymentError != null)
                {
                    <div class="alert alert-danger">
                        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Payment Failed</h5>
                        <p>@paymentError</p>
                    </div>
                }

                @if (invoice.Status != "Paid" && !paymentSuccess)
                {
                    <div class="mb-4">
                        <h5 class="mb-3">Select Payment Method:</h5>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="paymentMethod" id="stripe" value="Stripe" @onchange="() => selectedMethod = \"Stripe\"" checked="@(selectedMethod == \"Stripe\")" />
                            <label class="btn btn-outline-primary" for="stripe">
                                <i class="bi bi-credit-card"></i> Credit/Debit Card
                            </label>

                            <input type="radio" class="btn-check" name="paymentMethod" id="applepay" value="ApplePay" @onchange="() => selectedMethod = \"ApplePay\"" />
                            <label class="btn btn-outline-primary" for="applepay">
                                <i class="bi bi-apple"></i> Apple Pay
                            </label>

                            <input type="radio" class="btn-check" name="paymentMethod" id="googlepay" value="GooglePay" @onchange="() => selectedMethod = \"GooglePay\"" />
                            <label class="btn btn-outline-primary" for="googlepay">
                                <i class="bi bi-google"></i> Google Pay
                            </label>
                        </div>
                    </div>

                    @if (selectedMethod == "Stripe")
                    {
                        <div id="stripe-card-element" class="form-control mb-3" style="height: 50px; padding: 12px;"></div>
                    }

                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" @onclick="ProcessPayment" disabled="@processing">
                            @if (processing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <i class="bi bi-lock-fill me-2"></i>
                                <span>Pay @invoice.TotalAmount.ToString("C") Securely</span>
                            }
                        </button>
                    </div>

                    <p class="text-center text-muted mt-3 small">
                        <i class="bi bi-shield-check"></i> Your payment information is encrypted and secure
                    </p>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int InvoiceId { get; set; }

    private dynamic? invoice;
    private bool loading = true;
    private bool processing = false;
    private bool paymentSuccess = false;
    private string? paymentError;
    private string? transactionId;
    private string selectedMethod = "Stripe";

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoice();
    }

    private async Task LoadInvoice()
    {
        loading = true;
        try
        {
            invoice = await Http.GetFromJsonAsync<dynamic>($"api/SalesInvoices/{InvoiceId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading invoice: {ex.Message}");
        }
        loading = false;
    }

    private async Task ProcessPayment()
    {
        processing = true;
        paymentError = null;

        try
        {
            var paymentRequest = new
            {
                InvoiceId = InvoiceId,
                PaymentMethod = selectedMethod,
                Amount = invoice?.TotalAmount,
                Currency = "USD",
                CustomerEmail = "customer@example.com" // This would come from the invoice
            };

            var response = await Http.PostAsJsonAsync("api/Payment/process-payment", paymentRequest);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                transactionId = result?.TransactionId?.ToString();
                paymentSuccess = true;
            }
            else
            {
                paymentError = "Payment processing failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            paymentError = $"An error occurred: {ex.Message}";
        }

        processing = false;
    }
}
