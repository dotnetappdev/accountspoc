@page "/bill-of-materials"
@attribute [Authorize]
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@using MudBlazor
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Bill of Materials</PageTitle>

<div class="container-fluid">
    <h1 class="mb-4">Bill of Materials (BOM)</h1>

    <div class="row mb-3">
        <div class="col">
            <MudButton Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" OnClick="ShowAddForm">
                Create New BOM
            </MudButton>
        </div>
    </div>

    @if (showForm)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h5" Class="mb-4">@(editingBOM != null ? "Edit" : "Create") Bill of Materials</MudText>
            
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel Text="Basic Info" Icon="@Icons.Material.Filled.Info">
                    <EditForm Model="currentBOM">
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="currentBOM.BOMNumber" Label="BOM Number" Required="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="currentBOM.Name" Label="Name" Required="true" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="currentBOM.Description" Label="Description" Lines="3" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect @bind-Value="currentBOM.ProductId" Label="Product" Required="true">
                                    <MudSelectItem Value="0">-- Select Product --</MudSelectItem>
                                    @if (products != null)
                                    {
                                        @foreach (var product in products)
                                        {
                                            <MudSelectItem Value="@product.Id">@product.ProductName (@product.ProductCode)</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect @bind-Value="currentBOM.Status" Label="Status">
                                    <MudSelectItem Value="@("Active")">Active</MudSelectItem>
                                    <MudSelectItem Value="@("Draft")">Draft</MudSelectItem>
                                    <MudSelectItem Value="@("Pending")">Pending</MudSelectItem>
                                    <MudSelectItem Value="@("Obsolete")">Obsolete</MudSelectItem>
                                    <MudSelectItem Value="@("OnHold")">On Hold</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect @bind-Value="currentBOM.BOMType" Label="BOM Type">
                                    <MudSelectItem Value="@("Production")">Production</MudSelectItem>
                                    <MudSelectItem Value="@("Engineering")">Engineering</MudSelectItem>
                                    <MudSelectItem Value="@("Service")">Service</MudSelectItem>
                                    <MudSelectItem Value="@("Phantom")">Phantom</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="currentBOM.Version" Label="Version" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="currentBOM.Revision" Label="Revision" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="effectiveDate" Label="Effective Date" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="expiryDate" Label="Expiry Date" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudSwitch T="bool" @bind-Value="currentBOM.IsActive" Label="Active" Color="Color.Success" />
                            </MudItem>
                        </MudGrid>
                    </EditForm>
                </MudTabPanel>

                <MudTabPanel Text="Components" Icon="@Icons.Material.Filled.Inventory">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-3">Add Component</MudText>
                        </MudItem>
                        <MudItem xs="12" md="5">
                            <MudSelect @bind-Value="newComponentProductId" Label="Product" Required="true">
                                <MudSelectItem Value="0">-- Select Product --</MudSelectItem>
                                @if (products != null)
                                {
                                    @foreach (var product in products.Where(p => p.Id != currentBOM.ProductId))
                                    {
                                        <MudSelectItem Value="@product.Id">@product.ProductName (@product.ProductCode)</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudNumericField @bind-Value="newComponentQuantity" Label="Quantity" Min="1" />
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudNumericField @bind-Value="newComponentUnitCost" Label="Unit Cost" Min="0" Format="N2" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddComponent" FullWidth="true" StartIcon="@Icons.Material.Filled.Add">
                                Add Component
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (currentBOM.Components.Any())
                    {
                        <MudTable Items="@currentBOM.Components" Dense="true" Hover="true" Striped="true" Class="mt-4">
                            <HeaderContent>
                                <MudTh>Line</MudTh>
                                <MudTh>Product</MudTh>
                                <MudTh>Code</MudTh>
                                <MudTh Style="text-align:right">Quantity</MudTh>
                                <MudTh Style="text-align:right">Unit Cost</MudTh>
                                <MudTh Style="text-align:right">Total Cost</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Line">@context.LineNumber</MudTd>
                                <MudTd DataLabel="Product">@(context.Product?.ProductName ?? "Unknown")</MudTd>
                                <MudTd DataLabel="Code">@(context.Product?.ProductCode ?? "")</MudTd>
                                <MudTd DataLabel="Quantity" Style="text-align:right">@context.Quantity</MudTd>
                                <MudTd DataLabel="Unit Cost" Style="text-align:right">@context.UnitCost.ToString("C")</MudTd>
                                <MudTd DataLabel="Total Cost" Style="text-align:right">@context.TotalCost.ToString("C")</MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveComponent(context))" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        <MudPaper Class="pa-3 mt-3">
                            <MudText Typo="Typo.h6" Align="Align.End">
                                <strong>Material Cost: @CalculateMaterialCost().ToString("C")</strong>
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-4">No components added yet. Add components to build your BOM.</MudAlert>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Costing & Time" Icon="@Icons.Material.Filled.Calculate">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="currentBOM.SetupTime" Label="Setup Time (minutes)" Min="0" Format="N2" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="currentBOM.ProductionTime" Label="Production Time (minutes per unit)" Min="0" Format="N2" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="currentBOM.LabourCost" Label="Labour Cost" Min="0" Format="N2" Adornment="Adornment.Start" AdornmentText="$" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="currentBOM.OverheadCost" Label="Overhead Cost" Min="0" Format="N2" Adornment="Adornment.Start" AdornmentText="$" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField Value="@CalculateMaterialCost()" Label="Material Cost" ReadOnly="true" Format="N2" Adornment="Adornment.Start" AdornmentText="$" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="currentBOM.ScrapPercentage" Label="Scrap Percentage" Min="0" Max="100" Format="N2" Adornment="Adornment.End" AdornmentText="%" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="currentBOM.YieldPercentage" Label="Yield Percentage" Min="0" Max="100" Format="N2" Adornment="Adornment.End" AdornmentText="%" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudPaper Class="pa-4" Elevation="3">
                                <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Primary">
                                    <strong>Total Estimated Cost: @CalculateTotalCost().ToString("C")</strong>
                                </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Sales Order Integration" Icon="@Icons.Material.Filled.ShoppingCart">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudSwitch T="bool" @bind-Value="currentBOM.CanBeLinkedToSalesOrder" Label="Can be linked to Sales Orders" Color="Color.Success" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudSwitch T="bool" @bind-Value="currentBOM.AutoCreateFromSalesOrder" Label="Auto-create from Sales Order" Color="Color.Success" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudSwitch T="bool" @bind-Value="currentBOM.AllowPartialKitting" Label="Allow Partial Kitting" Color="Color.Success" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="currentBOM.MinimumBatchSize" Label="Minimum Batch Size" Min="0" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="currentBOM.MaximumBatchSize" Label="Maximum Batch Size" Min="0" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info">
                                When this BOM is linked to a sales order, it will be treated as a kit item. 
                                The system can automatically create assembly orders based on your settings.
                            </MudAlert>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Images" Icon="@Icons.Material.Filled.Image">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-3">Add Image</MudText>
                        </MudItem>
                        <MudItem xs="12" md="8">
                            <MudTextField @bind-Value="newImageUrl" Label="Image URL" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="newImageCaption" Label="Caption" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudSwitch T="bool" @bind-Value="newImageIsPrimary" Label="Primary Image" Color="Color.Primary" />
                        </MudItem>
                        <MudItem xs="12" md="8">
                            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddImage" StartIcon="@Icons.Material.Filled.Add" FullWidth="true">
                                Add Image
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (currentBOM.Images.Any())
                    {
                        <MudGrid Class="mt-4">
                            @foreach (var image in currentBOM.Images.OrderBy(i => i.DisplayOrder))
                            {
                                <MudItem xs="12" md="6" lg="4">
                                    <MudCard>
                                        <MudCardMedia Image="@image.ImageUrl" Height="200" />
                                        <MudCardContent>
                                            <MudText Typo="Typo.body2">@image.Caption</MudText>
                                            @if (image.IsPrimaryImage)
                                            {
                                                <MudChip T="string" Color="Color.Primary" Size="Size.Small">Primary</MudChip>
                                            }
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveImage(image))" />
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-4">No images added yet. Add product images to showcase the finished BOM item.</MudAlert>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Notes" Icon="@Icons.Material.Filled.Notes">
                    <MudTextField @bind-Value="currentBOM.Notes" Label="Notes" Lines="10" Variant="Variant.Outlined" />
                </MudTabPanel>
            </MudTabs>

            <MudDivider Class="my-4" />
            
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                <MudButton Color="Color.Default" Variant="Variant.Filled" OnClick="CancelForm">Cancel</MudButton>
                <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="SaveBOM" StartIcon="@Icons.Material.Filled.Save">Save BOM</MudButton>
            </MudStack>
        </MudPaper>
    }

    @if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (boms == null || !boms.Any())
    {
        <MudAlert Severity="Severity.Info">No BOMs found. Create your first Bill of Materials.</MudAlert>
    }
    else
    {
        <MudTable Items="@boms" Dense="false" Hover="true" Striped="true" Filter="new Func<BillOfMaterial,bool>(FilterFunc)">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Bill of Materials</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>BOM Number</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Product</MudTh>
                <MudTh Style="text-align:right">Components</MudTh>
                <MudTh Style="text-align:right">Total Cost</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="BOM Number">@context.BOMNumber</MudTd>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Product">@context.Product?.ProductName</MudTd>
                <MudTd DataLabel="Components" Style="text-align:right">@context.Components.Count</MudTd>
                <MudTd DataLabel="Total Cost" Style="text-align:right">@context.TotalCost?.ToString("C")</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
                </MudTd>
                <MudTd DataLabel="Type">@context.BOMType</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small" OnClick="@(() => EditBOM(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteBOM(context.Id))" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</div>

@code {
    private List<BillOfMaterial>? boms;
    private List<Product>? products;
    private BillOfMaterial currentBOM = new() { BOMNumber = "", Name = "" };
    private BillOfMaterial? editingBOM;
    private bool showForm = false;
    private bool loading = true;
    private string searchString = "";

    private DateTime? effectiveDate;
    private DateTime? expiryDate;

    private int newComponentProductId = 0;
    private int newComponentQuantity = 1;
    private decimal newComponentUnitCost = 0;

    private string newImageUrl = "";
    private string newImageCaption = "";
    private bool newImageIsPrimary = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            boms = await Http.GetFromJsonAsync<List<BillOfMaterial>>("api/BillOfMaterials");
            products = await Http.GetFromJsonAsync<List<Product>>("api/Products");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            boms = new List<BillOfMaterial>();
            products = new List<Product>();
        }
        loading = false;
    }

    private void ShowAddForm()
    {
        currentBOM = new() 
        { 
            BOMNumber = $"BOM-{DateTime.Now:yyyyMMddHHmmss}", 
            Name = "", 
            IsActive = true,
            Status = "Active",
            BOMType = "Production",
            CanBeLinkedToSalesOrder = true,
            AllowPartialKitting = true
        };
        editingBOM = null;
        effectiveDate = null;
        expiryDate = null;
        showForm = true;
    }

    private void EditBOM(BillOfMaterial bom)
    {
        editingBOM = bom;
        currentBOM = new BillOfMaterial
        {
            Id = bom.Id,
            BOMNumber = bom.BOMNumber,
            Name = bom.Name,
            Description = bom.Description,
            ProductId = bom.ProductId,
            Quantity = bom.Quantity,
            EstimatedCost = bom.EstimatedCost,
            Version = bom.Version,
            Revision = bom.Revision,
            BOMType = bom.BOMType,
            Status = bom.Status,
            EffectiveDate = bom.EffectiveDate,
            ExpiryDate = bom.ExpiryDate,
            SetupTime = bom.SetupTime,
            ProductionTime = bom.ProductionTime,
            TimeUOM = bom.TimeUOM,
            ScrapPercentage = bom.ScrapPercentage,
            YieldPercentage = bom.YieldPercentage,
            DefaultWarehouseId = bom.DefaultWarehouseId,
            LabourCost = bom.LabourCost,
            OverheadCost = bom.OverheadCost,
            MaterialCost = bom.MaterialCost,
            TotalCost = bom.TotalCost,
            CanBeLinkedToSalesOrder = bom.CanBeLinkedToSalesOrder,
            AutoCreateFromSalesOrder = bom.AutoCreateFromSalesOrder,
            AllowPartialKitting = bom.AllowPartialKitting,
            MinimumBatchSize = bom.MinimumBatchSize,
            MaximumBatchSize = bom.MaximumBatchSize,
            Notes = bom.Notes,
            IsActive = bom.IsActive,
            CreatedDate = bom.CreatedDate,
            LastModifiedDate = bom.LastModifiedDate,
            Components = new List<BOMComponent>(bom.Components.Select(c => new BOMComponent
            {
                Id = c.Id,
                BillOfMaterialId = c.BillOfMaterialId,
                ProductId = c.ProductId,
                Quantity = c.Quantity,
                UnitCost = c.UnitCost,
                TotalCost = c.TotalCost,
                LineNumber = c.LineNumber,
                Notes = c.Notes,
                ScrapPercentage = c.ScrapPercentage,
                IsOptional = c.IsOptional,
                Product = c.Product
            })),
            Images = new List<BOMImage>(bom.Images.Select(i => new BOMImage
            {
                Id = i.Id,
                BillOfMaterialId = i.BillOfMaterialId,
                ImageUrl = i.ImageUrl,
                ImageData = i.ImageData,
                Caption = i.Caption,
                DisplayOrder = i.DisplayOrder,
                IsPrimaryImage = i.IsPrimaryImage,
                CreatedDate = i.CreatedDate
            }))
        };
        effectiveDate = bom.EffectiveDate;
        expiryDate = bom.ExpiryDate;
        showForm = true;
    }

    private void AddComponent()
    {
        if (newComponentProductId > 0)
        {
            var product = products?.FirstOrDefault(p => p.Id == newComponentProductId);
            if (product != null)
            {
                var lineNumber = currentBOM.Components.Any() ? currentBOM.Components.Max(c => c.LineNumber) + 1 : 1;
                currentBOM.Components.Add(new BOMComponent
                {
                    ProductId = newComponentProductId,
                    Quantity = newComponentQuantity,
                    UnitCost = newComponentUnitCost,
                    TotalCost = newComponentQuantity * newComponentUnitCost,
                    LineNumber = lineNumber,
                    Product = product
                });
                
                newComponentProductId = 0;
                newComponentQuantity = 1;
                newComponentUnitCost = 0;
            }
        }
    }

    private void RemoveComponent(BOMComponent component)
    {
        currentBOM.Components.Remove(component);
    }

    private void AddImage()
    {
        if (!string.IsNullOrWhiteSpace(newImageUrl))
        {
            if (newImageIsPrimary)
            {
                foreach (var img in currentBOM.Images)
                {
                    img.IsPrimaryImage = false;
                }
            }

            var displayOrder = currentBOM.Images.Any() ? currentBOM.Images.Max(i => i.DisplayOrder) + 1 : 1;
            currentBOM.Images.Add(new BOMImage
            {
                ImageUrl = newImageUrl,
                Caption = newImageCaption,
                IsPrimaryImage = newImageIsPrimary,
                DisplayOrder = displayOrder,
                CreatedDate = DateTime.UtcNow
            });

            newImageUrl = "";
            newImageCaption = "";
            newImageIsPrimary = false;
        }
    }

    private void RemoveImage(BOMImage image)
    {
        currentBOM.Images.Remove(image);
    }

    private decimal CalculateMaterialCost()
    {
        return currentBOM.Components.Sum(c => c.TotalCost);
    }

    private decimal CalculateTotalCost()
    {
        return CalculateMaterialCost() 
            + (currentBOM.LabourCost ?? 0) 
            + (currentBOM.OverheadCost ?? 0);
    }

    private async Task SaveBOM()
    {
        try
        {
            currentBOM.EffectiveDate = effectiveDate;
            currentBOM.ExpiryDate = expiryDate;
            currentBOM.MaterialCost = CalculateMaterialCost();
            currentBOM.TotalCost = CalculateTotalCost();
            currentBOM.EstimatedCost = currentBOM.TotalCost.GetValueOrDefault();

            if (editingBOM != null)
            {
                await Http.PutAsJsonAsync($"api/BillOfMaterials/{currentBOM.Id}", currentBOM);
            }
            else
            {
                await Http.PostAsJsonAsync("api/BillOfMaterials", currentBOM);
            }
            
            showForm = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving BOM: {ex.Message}");
        }
    }

    private async Task DeleteBOM(int id)
    {
        try
        {
            await Http.DeleteAsync($"api/BillOfMaterials/{id}");
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting BOM: {ex.Message}");
        }
    }

    private void CancelForm()
    {
        showForm = false;
        editingBOM = null;
    }

    private bool FilterFunc(BillOfMaterial bom)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (bom.BOMNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (bom.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (bom.Product?.ProductName?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Draft" => Color.Info,
        "Pending" => Color.Warning,
        "Obsolete" => Color.Error,
        "OnHold" => Color.Default,
        _ => Color.Default
    };
}
