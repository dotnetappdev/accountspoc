@page "/site-visits"
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Site Visits</PageTitle>

<div class="container-fluid">
    <h1 class="mb-4">Site Visits</h1>

    <div class="row mb-3">
        <div class="col">
            <button class="btn btn-primary" @onclick="ShowAddForm">
                <i class="bi bi-plus-circle"></i> Create New Site Visit
            </button>
        </div>
    </div>

    @if (showForm)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>@(editingVisit != null ? "Edit" : "Create") Site Visit</h5>
            </div>
            <div class="card-body">
                <EditForm Model="currentVisit" OnValidSubmit="SaveSiteVisit">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Visit Number</label>
                            <InputText class="form-control" @bind-Value="currentVisit.VisitNumber" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Visit Type</label>
                            <InputSelect class="form-select" @bind-Value="currentVisit.VisitType">
                                <option value="Initial">Initial</option>
                                <option value="Progress">Progress</option>
                                <option value="Completion">Completion</option>
                                <option value="Inspection">Inspection</option>
                                <option value="Emergency">Emergency</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Visit Date</label>
                            <InputDate class="form-control" @bind-Value="currentVisit.VisitDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <InputSelect class="form-select" @bind-Value="currentVisit.Status">
                                <option value="Scheduled">Scheduled</option>
                                <option value="InProgress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Scheduled Start Time</label>
                            <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="currentVisit.ScheduledStartTime" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Scheduled End Time</label>
                            <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="currentVisit.ScheduledEndTime" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <InputText class="form-control" @bind-Value="currentVisit.CustomerName" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Site Address</label>
                        <InputText class="form-control" @bind-Value="currentVisit.SiteAddress" />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Site City</label>
                            <InputText class="form-control" @bind-Value="currentVisit.SiteCity" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Site Postcode</label>
                            <InputText class="form-control" @bind-Value="currentVisit.SitePostCode" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Site Contact Name</label>
                            <InputText class="form-control" @bind-Value="currentVisit.SiteContactName" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Site Contact Phone</label>
                            <InputText class="form-control" @bind-Value="currentVisit.SiteContactPhone" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Purpose</label>
                        <InputTextArea class="form-control" @bind-Value="currentVisit.Purpose" rows="2" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <InputTextArea class="form-control" @bind-Value="currentVisit.Notes" rows="3" />
                    </div>
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </EditForm>
            </div>
        </div>
    }

    @if (selectedVisit != null)
    {
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Assign Work Orders to Visit: @selectedVisit.VisitNumber</h5>
                <button class="btn btn-sm btn-secondary" @onclick="CloseWorkOrderAssignment">
                    <i class="bi bi-x"></i> Close
                </button>
            </div>
            <div class="card-body">
                <h6>Available Work Orders</h6>
                @if (availableWorkOrders == null || !availableWorkOrders.Any())
                {
                    <p class="text-muted">No unassigned work orders available</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Work Order #</th>
                                    <th>Customer</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var wo in availableWorkOrders)
                                {
                                    <tr>
                                        <td>@wo.WorkOrderNumber</td>
                                        <td>@wo.CustomerName</td>
                                        <td>@(wo.Description.Length > 50 ? wo.Description.Substring(0, 50) + "..." : wo.Description)</td>
                                        <td><span class="badge bg-info">@wo.Status</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-success" @onclick="() => AssignWorkOrder(wo.Id)">
                                                <i class="bi bi-plus"></i> Assign
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <h6 class="mt-4">Assigned Work Orders</h6>
                @if (assignedWorkOrders == null || !assignedWorkOrders.Any())
                {
                    <p class="text-muted">No work orders assigned to this visit yet</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Work Order #</th>
                                    <th>Customer</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var wo in assignedWorkOrders)
                                {
                                    <tr>
                                        <td>@wo.WorkOrderNumber</td>
                                        <td>@wo.CustomerName</td>
                                        <td>@(wo.Description.Length > 50 ? wo.Description.Substring(0, 50) + "..." : wo.Description)</td>
                                        <td><span class="badge bg-success">@wo.Status</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" @onclick="() => UnassignWorkOrder(wo.Id)">
                                                <i class="bi bi-dash"></i> Unassign
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (siteVisits == null || !siteVisits.Any())
    {
        <div class="alert alert-info">No site visits found.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Visit Number</th>
                        <th>Customer</th>
                        <th>Visit Date</th>
                        <th>Visit Type</th>
                        <th>Status</th>
                        <th>Site Address</th>
                        <th>Work Orders</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var visit in siteVisits)
                    {
                        <tr>
                            <td>@visit.VisitNumber</td>
                            <td>@visit.CustomerName</td>
                            <td>@visit.VisitDate.ToShortDateString()</td>
                            <td>
                                <span class="badge bg-info">
                                    @visit.VisitType
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-@GetStatusColor(visit.Status)">
                                    @visit.Status
                                </span>
                            </td>
                            <td>@visit.SiteAddress, @visit.SiteCity</td>
                            <td>
                                <span class="badge bg-primary">@visit.WorkOrderCount</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" @onclick="() => EditSiteVisit(visit)">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-info" @onclick="() => ManageWorkOrders(visit)">
                                    <i class="bi bi-list-task"></i> Assign Work Orders
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteSiteVisit(visit.Id)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<SiteVisit>? siteVisits;
    private List<WorkOrder>? availableWorkOrders;
    private List<WorkOrder>? assignedWorkOrders;
    private List<WorkOrder>? allWorkOrders;
    private SiteVisit currentVisit = new SiteVisit 
    { 
        VisitNumber = $"SV-{DateTime.Now:yyyyMMddHHmmss}",
        VisitDate = DateTime.Now,
        VisitType = "Initial",
        Status = "Scheduled",
        TenantId = 1
    };
    private SiteVisit? editingVisit;
    private SiteVisit? selectedVisit;
    private bool showForm = false;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSiteVisits();
        await LoadAllWorkOrders();
    }

    private async Task LoadSiteVisits()
    {
        loading = true;
        try
        {
            var result = await Http.GetFromJsonAsync<List<SiteVisitDto>>("http://localhost:5001/api/SiteVisits");
            siteVisits = result?.Select(v => new SiteVisit
            {
                Id = v.Id,
                VisitNumber = v.VisitNumber,
                VisitDate = v.VisitDate,
                VisitType = v.VisitType,
                Status = v.Status,
                CustomerName = v.CustomerName,
                SiteAddress = v.SiteAddress,
                SiteCity = v.SiteCity,
                SitePostCode = v.SitePostCode,
                SiteContactName = v.SiteContactName,
                SiteContactPhone = v.SiteContactPhone,
                Purpose = v.Purpose,
                Notes = v.Notes,
                ScheduledStartTime = v.ScheduledStartTime,
                ScheduledEndTime = v.ScheduledEndTime,
                WorkOrderCount = v.WorkOrders?.Count ?? 0
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading site visits: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadAllWorkOrders()
    {
        try
        {
            allWorkOrders = await Http.GetFromJsonAsync<List<WorkOrder>>("http://localhost:5001/api/WorkOrders");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading work orders: {ex.Message}");
        }
    }

    private void ShowAddForm()
    {
        currentVisit = new SiteVisit 
        { 
            VisitNumber = $"SV-{DateTime.Now:yyyyMMddHHmmss}",
            VisitDate = DateTime.Now,
            VisitType = "Initial",
            Status = "Scheduled",
            TenantId = 1
        };
        editingVisit = null;
        showForm = true;
    }

    private void EditSiteVisit(SiteVisit visit)
    {
        currentVisit = visit;
        editingVisit = visit;
        showForm = true;
    }

    private async Task SaveSiteVisit()
    {
        try
        {
            if (editingVisit != null)
            {
                await Http.PutAsJsonAsync($"http://localhost:5001/api/SiteVisits/{currentVisit.Id}", currentVisit);
            }
            else
            {
                await Http.PostAsJsonAsync("http://localhost:5001/api/SiteVisits", currentVisit);
            }
            
            await LoadSiteVisits();
            CancelForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving site visit: {ex.Message}");
        }
    }

    private async Task DeleteSiteVisit(int id)
    {
        if (confirm("Are you sure you want to delete this site visit?"))
        {
            try
            {
                await Http.DeleteAsync($"http://localhost:5001/api/SiteVisits/{id}");
                await LoadSiteVisits();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting site visit: {ex.Message}");
            }
        }
    }

    private async Task ManageWorkOrders(SiteVisit visit)
    {
        selectedVisit = visit;
        await LoadWorkOrdersForVisit();
    }

    private async Task LoadWorkOrdersForVisit()
    {
        if (selectedVisit == null) return;

        try
        {
            assignedWorkOrders = await Http.GetFromJsonAsync<List<WorkOrder>>(
                $"http://localhost:5001/api/SiteVisits/{selectedVisit.Id}/workorders");
            
            availableWorkOrders = allWorkOrders?
                .Where(wo => wo.SiteVisitId == null || wo.SiteVisitId == 0)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading work orders for visit: {ex.Message}");
        }
    }

    private async Task AssignWorkOrder(int workOrderId)
    {
        if (selectedVisit == null) return;

        try
        {
            await Http.PostAsync($"http://localhost:5001/api/SiteVisits/{selectedVisit.Id}/assign-workorder/{workOrderId}", null);
            await LoadAllWorkOrders();
            await LoadWorkOrdersForVisit();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error assigning work order: {ex.Message}");
        }
    }

    private async Task UnassignWorkOrder(int workOrderId)
    {
        if (selectedVisit == null) return;

        try
        {
            await Http.PostAsync($"http://localhost:5001/api/SiteVisits/{selectedVisit.Id}/unassign-workorder/{workOrderId}", null);
            await LoadAllWorkOrders();
            await LoadWorkOrdersForVisit();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error unassigning work order: {ex.Message}");
        }
    }

    private void CloseWorkOrderAssignment()
    {
        selectedVisit = null;
        assignedWorkOrders = null;
        availableWorkOrders = null;
    }

    private void CancelForm()
    {
        showForm = false;
        editingVisit = null;
    }

    private string GetStatusColor(string status) => status switch
    {
        "Scheduled" => "info",
        "InProgress" => "primary",
        "Completed" => "success",
        "Cancelled" => "danger",
        _ => "secondary"
    };

    private bool confirm(string message)
    {
        // In a real implementation, use JS interop for confirmation
        return true;
    }

    public class SiteVisit
    {
        public int Id { get; set; }
        public int TenantId { get; set; }
        public string VisitNumber { get; set; } = "";
        public DateTime VisitDate { get; set; }
        public DateTime? ScheduledStartTime { get; set; }
        public DateTime? ScheduledEndTime { get; set; }
        public string VisitType { get; set; } = "";
        public string Status { get; set; } = "";
        public string? CustomerName { get; set; }
        public string? SiteAddress { get; set; }
        public string? SiteCity { get; set; }
        public string? SitePostCode { get; set; }
        public string? SiteContactName { get; set; }
        public string? SiteContactPhone { get; set; }
        public string? Purpose { get; set; }
        public string? Notes { get; set; }
        public int WorkOrderCount { get; set; }
    }

    public class SiteVisitDto
    {
        public int Id { get; set; }
        public string VisitNumber { get; set; } = "";
        public DateTime VisitDate { get; set; }
        public DateTime? ScheduledStartTime { get; set; }
        public DateTime? ScheduledEndTime { get; set; }
        public string VisitType { get; set; } = "";
        public string Status { get; set; } = "";
        public string? CustomerName { get; set; }
        public string? SiteAddress { get; set; }
        public string? SiteCity { get; set; }
        public string? SitePostCode { get; set; }
        public string? SiteContactName { get; set; }
        public string? SiteContactPhone { get; set; }
        public string? Purpose { get; set; }
        public string? Notes { get; set; }
        public List<WorkOrder>? WorkOrders { get; set; }
    }

    public class WorkOrder
    {
        public int Id { get; set; }
        public string WorkOrderNumber { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public string Description { get; set; } = "";
        public string Status { get; set; } = "";
        public int? SiteVisitId { get; set; }
    }
}
