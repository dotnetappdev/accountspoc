@page "/quotes"
@attribute [Authorize]
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Quotes</PageTitle>

<div class="container-fluid">
    <h1 class="mb-4">Quotes</h1>

    <div class="row mb-3">
        <div class="col">
            <button class="btn btn-primary" @onclick="ShowAddForm">
                <i class="bi bi-plus-circle"></i> Create New Quote
            </button>
        </div>
    </div>

    @if (showForm)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>@(editingQuote != null ? "Edit" : "Create") Quote</h5>
            </div>
            <div class="card-body">
                <EditForm Model="currentQuote" OnValidSubmit="SaveQuote">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quote Number</label>
                            <InputText class="form-control" @bind-Value="currentQuote.QuoteNumber" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Name</label>
                            <InputText class="form-control" @bind-Value="currentQuote.CustomerName" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Email</label>
                            <InputText class="form-control" type="email" @bind-Value="currentQuote.CustomerEmail" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Phone</label>
                            <InputText class="form-control" @bind-Value="currentQuote.CustomerPhone" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <InputDate class="form-control" @bind-Value="currentQuote.ExpiryDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <InputSelect class="form-select" @bind-Value="currentQuote.Status">
                                <option value="Draft">Draft</option>
                                <option value="Sent">Sent</option>
                                <option value="Accepted">Accepted</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Expired">Expired</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Notes</label>
                        <InputTextArea class="form-control" @bind-Value="currentQuote.CustomerNotes" rows="3" />
                    </div>
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </EditForm>
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (quotes == null || !quotes.Any())
    {
        <div class="alert alert-info">No quotes found.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Quote Number</th>
                        <th>Customer</th>
                        <th>Quote Date</th>
                        <th>Expiry Date</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var quote in quotes)
                    {
                        <tr>
                            <td>@quote.QuoteNumber</td>
                            <td>@quote.CustomerName</td>
                            <td>@quote.QuoteDate.ToShortDateString()</td>
                            <td>@(quote.ExpiryDate?.ToShortDateString() ?? "N/A")</td>
                            <td>@quote.TotalAmount.ToString("C")</td>
                            <td>
                                <span class="badge bg-@GetStatusColor(quote.Status)">
                                    @quote.Status
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" @onclick="() => EditQuote(quote)">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                @if (quote.Status == "Accepted")
                                {
                                    <button class="btn btn-sm btn-success" @onclick="() => ConvertToOrder(quote.Id)">
                                        <i class="bi bi-arrow-right-circle"></i> Convert to Order
                                    </button>
                                }
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteQuote(quote.Id)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Quote>? quotes;
    private Quote currentQuote = new Quote 
    { 
        QuoteNumber = $"QT-{DateTime.Now:yyyyMMddHHmmss}",
        CustomerName = "",
        QuoteDate = DateTime.Now,
        Status = "Draft",
        TenantId = 1
    };
    private Quote? editingQuote;
    private bool showForm = false;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadQuotes();
    }

    private async Task LoadQuotes()
    {
        loading = true;
        try
        {
            quotes = await Http.GetFromJsonAsync<List<Quote>>("http://localhost:5001/api/Quotes");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading quotes: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowAddForm()
    {
        currentQuote = new Quote 
        { 
            QuoteNumber = $"QT-{DateTime.Now:yyyyMMddHHmmss}",
            CustomerName = "",
            QuoteDate = DateTime.Now,
            Status = "Draft",
            TenantId = 1
        };
        editingQuote = null;
        showForm = true;
    }

    private void EditQuote(Quote quote)
    {
        currentQuote = quote;
        editingQuote = quote;
        showForm = true;
    }

    private async Task SaveQuote()
    {
        try
        {
            if (editingQuote != null)
            {
                await Http.PutAsJsonAsync($"http://localhost:5001/api/Quotes/{currentQuote.Id}", currentQuote);
            }
            else
            {
                await Http.PostAsJsonAsync("http://localhost:5001/api/Quotes", currentQuote);
            }
            
            await LoadQuotes();
            CancelForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving quote: {ex.Message}");
        }
    }

    private async Task DeleteQuote(int id)
    {
        if (confirm("Are you sure you want to delete this quote?"))
        {
            try
            {
                await Http.DeleteAsync($"http://localhost:5001/api/Quotes/{id}");
                await LoadQuotes();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting quote: {ex.Message}");
            }
        }
    }

    private async Task ConvertToOrder(int quoteId)
    {
        try
        {
            var response = await Http.PostAsync($"http://localhost:5001/api/Quotes/{quoteId}/convert-to-order", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadQuotes();
                // Navigate to sales orders or show success message
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error converting quote: {ex.Message}");
        }
    }

    private void CancelForm()
    {
        showForm = false;
        editingQuote = null;
    }

    private string GetStatusColor(string status) => status switch
    {
        "Draft" => "secondary",
        "Sent" => "info",
        "Accepted" => "success",
        "Rejected" => "danger",
        "Expired" => "warning",
        "Converted" => "primary",
        _ => "secondary"
    };

    private bool confirm(string message)
    {
        // In a real implementation, use JS interop for confirmation
        return true;
    }

    public class Quote
    {
        public int Id { get; set; }
        public int TenantId { get; set; }
        public string QuoteNumber { get; set; } = "";
        public DateTime QuoteDate { get; set; }
        public DateTime? ExpiryDate { get; set; }
        public string CustomerName { get; set; } = "";
        public string? CustomerEmail { get; set; }
        public string? CustomerPhone { get; set; }
        public decimal SubTotal { get; set; }
        public decimal TaxAmount { get; set; }
        public decimal DiscountAmount { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } = "Draft";
        public string? CustomerNotes { get; set; }
    }
}
