@page "/roles"
@attribute [Authorize]
@using System.Net.Http.Json
@using AccountsPOC.BlazorApp.Models
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Role Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-2" />
        Role Management
    </MudText>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowAddForm" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-1" />
        Add New Role
    </MudButton>

    @if (showForm)
    {
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@(editingRole != null ? "Edit Role" : "Create New Role")</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="roleForm.Name" Label="Role Name" Required="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="roleForm.Description" Label="Description" Lines="3" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudSelect T="int" Label="Permissions" MultiSelection="true" @bind-SelectedValues="selectedPermissionIds">
                            @foreach (var permission in availablePermissions)
                            {
                                <MudSelectItem T="int" Value="@permission.Id">@permission.Name (@permission.Resource - @permission.Action)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveRole">
                    <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                    Save
                </MudButton>
                <MudButton Variant="Variant.Outlined" OnClick="CancelForm">Cancel</MudButton>
            </MudCardActions>
        </MudCard>
    }

    <MudDataGrid T="Role" Items="@roles" Filterable="true" QuickFilter="@_quickFilter" 
                 Loading="@loading" Hover="true" Dense="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Roles</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Placeholder="Search..." Adornment="Adornment.Start" 
                         AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Role Name" />
            <PropertyColumn Property="x => x.Description" Title="Description" />
            <PropertyColumn Property="x => x.IsSystemRole" Title="System Role">
                <CellTemplate>
                    @if (context.Item.IsSystemRole)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info">System Role</MudChip>
                    }
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Permissions" Filterable="false">
                <CellTemplate>
                    @if (context.Item.Permissions != null && context.Item.Permissions.Any())
                    {
                        <MudText Typo="Typo.body2">@context.Item.Permissions.Count permissions</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Actions" Filterable="false" Sortable="false">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                     Color="Color.Warning" 
                                     Size="Size.Small" 
                                     OnClick="@(() => EditRole(context.Item))" 
                                     Disabled="@context.Item.IsSystemRole" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                     Color="Color.Error" 
                                     Size="Size.Small" 
                                     OnClick="@(() => DeleteRole(context.Item.Id))" 
                                     Disabled="@context.Item.IsSystemRole" />
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Role" PageSizeOptions="new int[] { 10, 25, 50 }" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
    private List<Role> roles = new();
    private List<Permission> availablePermissions = new();
    private RoleForm roleForm = new();
    private Role? editingRole;
    private bool showForm = false;
    private bool loading = true;
    private string _searchString = "";
    private IEnumerable<int> selectedPermissionIds = new List<int>();

    private Func<Role, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.Description?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            roles = await Http.GetFromJsonAsync<List<Role>>("api/Roles") ?? new();
            availablePermissions = await Http.GetFromJsonAsync<List<Permission>>("api/Permissions") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        loading = false;
    }

    private void ShowAddForm()
    {
        roleForm = new();
        editingRole = null;
        selectedPermissionIds = new List<int>();
        showForm = true;
    }

    private void EditRole(Role role)
    {
        editingRole = role;
        roleForm = new RoleForm
        {
            Id = role.Id,
            Name = role.Name,
            Description = role.Description
        };
        selectedPermissionIds = role.Permissions?.Select(p => p.Id) ?? new List<int>();
        showForm = true;
    }

    private async Task SaveRole()
    {
        try
        {
            var dto = new
            {
                roleForm.Name,
                roleForm.Description,
                PermissionIds = selectedPermissionIds.ToList()
            };

            if (editingRole != null)
            {
                await Http.PutAsJsonAsync($"api/Roles/{roleForm.Id}", dto);
            }
            else
            {
                await Http.PostAsJsonAsync("api/Roles", dto);
            }
            
            showForm = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving role: {ex.Message}");
        }
    }

    private async Task DeleteRole(int id)
    {
        try
        {
            await Http.DeleteAsync($"api/Roles/{id}");
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting role: {ex.Message}");
        }
    }

    private void CancelForm()
    {
        showForm = false;
        editingRole = null;
    }

    private class RoleForm
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string? Description { get; set; }
    }
}
